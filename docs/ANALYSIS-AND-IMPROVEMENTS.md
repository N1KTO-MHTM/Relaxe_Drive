# RelaxDrive — анализ функционала и идеи улучшений

Проведён обзор backend, web и desktop. Ниже — что уже работает, где пробелы и что можно добавить/улучшить.

---

## Что уже хорошо работает

### Backend
- **Auth**: регистрация, логин, refresh, logout, forgot-password (без отправки письма — только лог + сообщение «обратитесь к админу»).
- **Users**: профиль, смена роли/пароля, блок/бан, сессии (одна запись на пользователя), **GET /users/with-session-status** для админа (зарегистрированные аккаунты + актив/офлайн).
- **Orders**: CRUD, назначение водителя, отказ, статусы, маршрут с альтернативами и ETA, завершение с авто-добавлением клиента.
- **Passengers**: список, добавление, **PATCH/DELETE** (редактирование и удаление клиентов).
- **Geo**: OSRM маршруты (в т.ч. альтернативы), Nominatim геокодирование.
- **Reports**: отчёты водителей (полиция, трафик, зона работ, ДТП) — создание, список по bbox, WebSocket.
- **Analytics**: реальные данные по заказам (созданные/завершённые, по статусам, тепловая карта по аудиту).
- **Cost Control**: счётчики maps/translation/ai/tts, лимиты через env, флаги превышения.
- **Audit**: логи с фильтрами (userId, action, resource, from, to).
- **WebSocket**: orders, drivers, alerts, user.updated, **report**.

### Web
- **Dashboard**: заказы (активные/завершённые, фильтр, экспорт CSV), карта, создание заказа, назначение, для водителя — таймер ожидания (с авто-стопом по движению), альтернативные маршруты, Recheck ETA, отчёты на карте, «Report», ссылки Google Maps / Waze.
- **Calendar**: день/неделя, конфликты, создание заказа на день.
- **Passengers**: поиск, добавление, редактирование, удаление, экспорт CSV, «+ New order».
- **Drivers**: список, поиск, экспорт, статусы, доступность (available).
- **Session Monitor**: активные сессии (по одному на пользователя), для админа — вкладка «Зарегистрированные аккаунты» с фильтрами и телефонами.
- **Analytics**: фильтр по датам, карточки (созданные/завершённые/по статусам), тепловая карта.
- **Cost Control**: счётчики, лимиты, предупреждение при превышении.
- **Roles**: смена роли, сброс пароля.
- **About**: описание по ролям.
- Lazy-роуты, Error Boundary с retry, пагинация (Passengers, Drivers, Sessions).

### Desktop
- **Control**: заказы, водители, сессии; уведомления при назначении водителю.
- **Live Wall**: карта, алерты.
- **Admin**: пользователи, роли, блок/бан, сброс пароля.
- **Clients**: клиенты.
- **Drivers**: водители.
- **Calendar**: календарь заказов.
- **Logs**: аудит с фильтрами.
- **Health**: состояние системы.
- **About**: о приложении.

---

## Пробелы и заглушки

| Область | Проблема |
|--------|----------|
| **Translation (Web)** | Страница — только текст. Backend есть TranslationService (LibreTranslate + запись в БД), но **нет REST API** и нет UI: ввод текста, выбор языка, перевод, история. |
| **White Label (Web)** | Только текст. Backend: WhiteLabelService.getConfig(tenantId), **нет контроллера**. Нет UI: логотип, цвета, домены. |
| **Audit (Web)** | Нет страницы «Логи/аудит». API есть (GET /audit), на desktop — LogsAuditMode. |
| **Forgot password** | Не отправляет письмо — только лог и ответ «обратитесь к админу». Для реального сброса нужна почта или отдельный flow. |
| **Desktop** | Нет: Analytics, Cost Control, Translation, White Label, отчёты на карте, альтернативные маршруты, «Зарегистрированные аккаунты» в сессиях. |
| **Health (Web)** | Нет страницы состояния API/БД; на desktop есть SystemHealthMode. |
| **Диспетчер в Passengers** | В описании docs — «админ видит phone, диспетчер — без phone». Стоит проверить, что диспетчер действительно не видит телефоны клиентов, если так задумано. |

---

## Что можно улучшить и добавить

### Высокий приоритет (польза для пользователей)

1. **Translation (Web) — полноценный центр перевода**
   - Backend: добавить `POST /translation/translate` (текст, sourceLang, targetLang) и `GET /translation/history` (последние N записей).
   - Web: форма (поле ввода, выбор языка источника/цели, кнопка «Перевести»), показ результата, блок «История» из API. Опционально: голосовой ввод (браузерный Web API).

2. **Страница Audit на Web**
   - Вызов `GET /audit` с фильтрами (дата, пользователь, action, resource), таблица логов. Доступ ADMIN/DISPATCHER, как на desktop.

3. **Desktop: синхрон с Web**
   - В Control/Sessions: вкладка «Зарегистрированные аккаунты» для админа (как на web), с телефонами и фильтрами.
   - При наличии карты в desktop — показ отчётов водителей (report markers) и, по возможности, альтернативных маршрутов.

### Средний приоритет

4. **White Label**
   - Backend: `GET/PUT /white-label/config` (логотип URL, primaryColor и т.д.), привязка к tenantId или глобальный конфиг.
   - Web (и при желании desktop): страница настроек логотипа и цветов, применение в шапке/теме.

5. **Forgot password — реальный сброс**
   - Вариант A: письмо со ссылкой (нужен SMTP или сервис отправки).
   - Вариант B: «секретный код» от админа: админ генерирует одноразовую ссылку/код, пользователь вводит его на странице сброса и новый пароль.

6. **Health на Web**
   - Страница «Состояние системы» (ADMIN): вызов `GET /health`, отображение статуса БД, при необходимости — других зависимостей.

7. **Уведомления в браузере**
   - Запрос разрешения на Notification API и показ браузерных уведомлений при новом назначении водителю или новом заказе для диспетчера (по аналогии с desktop).

8. **Офлайн / повтор запросов**
   - При потере сети: показ «Нет соединения» и автоматический повтор запросов или переподключение WebSocket без лишних ошибок в UI.

### Низкий приоритет / полировка

9. **Документация API**
   - Swagger/OpenAPI для backend (например, `@nestjs/swagger`) и ссылка из `GET /` или из About.

10. **Локализация**
    - Проверить, что все новые строки (отчёты, аналитика, сессии, маршруты) есть в ru, es, ka; при необходимости вынести общие ключи в один слой.

11. **Тесты**
    - Расширить e2e/unit на критические сценарии: создание заказа, назначение, смена статуса, перевод (после появления API).

12. **Производительность**
    - Крупные списки (заказы, клиенты): при росте данных — виртуализация или курсорная пагинация на backend (limit/offset или cursor).

---

## Краткая сводка

- **Уже сильно сделано**: заказы, водители, клиенты, карта, маршруты и ETA, отчёты на карте, аналитика, контроль затрат, сессии и зарегистрированные аккаунты, роли, аудит (API + desktop).
- **Имеет смысл доделать в первую очередь**: Translation на web (API + UI), страница Audit на web, выравнивание desktop с web (аккаунты в сессиях, отчёты на карте).
- **Дальше**: White Label, нормальный сброс пароля, Health на web, браузерные уведомления, офлайн-поведение, документация API и тесты.

Файл можно использовать как дорожную карту для следующих спринтов.
