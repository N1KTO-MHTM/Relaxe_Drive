# RelaxDrive — автоматизированные процессы и улучшения

Описание того, что уже автоматизировано, и что можно улучшить или добавить.

---

## 1. Уже автоматизировано

### 1.0 Планировщик (cron) и сессии
- **Cron (SchedulerService)**: раз в день в 3:00 — удаление сессий старше 90 дней (`SESSION_CLEANUP_DAYS`); раз в день в 4:00 — удаление записей DriverTripSummary старше 7 дней; каждые 5 мин — напоминания о подаче в ближайшие 15 мин (алерт `reminder_pickup_soon`); каждый час — проверка лимитов Cost Control и алерт `cost_limit_exceeded` при превышении.
- **lastActiveAt**: при каждом успешном JWT-запросе обновляется `lastActiveAt` у всех сессий этого пользователя (Session Monitor показывает реальное время последней активности).

### 1.1 Деплой (Render)
- **Сборка и запуск**: при пуше в репозиторий Render по `render.yaml` собирает backend (Prisma + Nest) и web (Vite), применяет миграции и поднимает API и статику.
- **База**: PostgreSQL создаётся и подключается по Blueprint; миграции выполняются в `startCommand`: `npx prisma migrate deploy && npm run start:prod`.

### 1.2 События заказов и уведомления
- **WebSocket**: при создании, назначении, отклонении и завершении заказа сервер рассылает обновлённый список заказов (`orders`) и алерты (`alerts`) всем подключённым клиентам — дашборд и десктоп обновляются без перезагрузки.
- **Алерты**: типы `order.created`, `order.assigned`, `order.rejected`, `order.completed` — отображаются в блоке «Alerts» на дашборде.

### 1.3 Аудит
- **Логирование действий**: создание/редактирование заказа, назначение водителя, смена роли, блок/бан, сброс пароля, вход/выход, сброс пароля по ссылке и т.д. пишутся в `AuditLog` и доступны через `GET /audit` (и в десктопе — Logs).

### 1.4 Очистка истории поездок водителя
- **При завершении заказа**: для водителя создаётся запись в `DriverTripSummary`, обновляется `DriverStats` (заработок и мили). Старые записи `DriverTripSummary` (старше 7 дней) удаляются при каждом завершении заказа этим водителем. Сводные цифры в `DriverStats` не очищаются.

### 1.5 Обновление данных на клиенте по таймеру
- **Дашборд (web)**: список заказов и позиции водителей — раз в 5 с; время «сейчас» — раз в 1 с (для таймеров ожидания); геолокация водителя отправляется на сервер с заданным интервалом.
- **Session Monitor**: сессии и аккаунты — раз в 30 с.
- **Cost Control**: счётчики — раз в 60 с и при фокусе окна.
- **Health (desktop)**: проверка состояния — по интервалу (например, 30 с).
- **Карта (OrdersMap)**: обновление вида в нав-режиме — раз в 2 с.

### 1.6 Обратное геокодирование
- **Nominatim**: ограничение по частоте запросов (`NOMINATIM_MIN_INTERVAL_MS`) в `geo.service.ts`, чтобы не превышать лимиты бесплатного API.

### 1.7 Устойчивость HTTP
- **Retry**: в `http-resilience.ts` повтор запроса с задержкой при сбоях.

### 1.8 Скрипты и тесты
- **Корень**: `install:all`, `build:all`, `backend`, `web`, `desktop`, `test`, `typecheck`.
- **Backend**: `prisma:generate`, `prisma:migrate`, `prisma:seed`, `prisma:studio`, `prisma:delete-non-admin`.
- **Web**: юнит-тесты (например, `exportCsv`), typecheck через `npm run build`.

---

## 2. Что можно улучшить или добавить

### 2.1 Плановые (cron) — реализовано
Реализовано в `SchedulerModule`: очистка старых сессий (90 дней), глобальная очистка DriverTripSummary (7 дней), напоминания о подаче (каждые 5 мин, алерт за 15 мин до pickupAt), проверка лимитов Cost Control (каждый час). Обновление `lastActiveAt` при каждом запросе с JWT — реализовано в JwtStrategy + UsersService.touchSessionsByUserId.

| Задача | Статус |
|--------|--------|
| Очистка старых сессий | ✅ Cron 0 3 * * * |
| Глобальная очистка DriverTripSummary | ✅ Cron 0 4 * * * |
| Напоминания о подаче | ✅ Cron */5 * * * *, алерт reminder_pickup_soon |
| Cost limit alert | ✅ Cron 0 * * * * |
| lastActiveAt при запросе | ✅ JwtStrategy + touchSessionsByUserId |

| Задача | Описание | Приоритет |
|--------|----------|-----------|
| **Авто-назначение водителя** | По правилам (ближайший свободный, по типу машины и т.д.) при создании заказа или по таймеру для заказов в статусе SCHEDULED. | Низкий |

### 2.2 Обновление «последней активности» сессии — реализовано
- При каждом успешном JWT-запросе вызывается `UsersService.touchSessionsByUserId(user.id)`, обновляется `lastActiveAt` у всех сессий пользователя.

### 2.3 CI/CD и качество кода — реализовано
- **GitHub Actions** (`.github/workflows/ci.yml`): на push/PR в main, master, develop запускаются job `web` (install, build, test) и `backend` (install, prisma generate, build). Опционально можно добавить деплой на staging при пуше в develop.

### 2.4 Аналитика и отчёты
- **Сейчас**: Analytics (heatmap) — заглушка; данные по заказам есть в БД.
- **Улучшение**: реализовать `GET /analytics/heatmap?from=&to=` на основе `Order`/`AuditLog` (создание и завершение заказов по дням/часам). Дальше — экспорт отчётов (например, по поездкам водителей за период) по расписанию или по кнопке.

### 2.5 Уведомления за пределами дашборда
- **Сейчас**: уведомления только через WebSocket в браузере/десктопе.
- **Добавить (по желанию)**: email при сбросе пароля уже есть; можно добавить опциональные email/push при назначении заказа водителю или при новом заказе для диспетчера (чтобы не пропустить, если вкладка закрыта).

### 2.6 Лимиты и алерты Cost Control — реализовано
- Каждый час cron вызывает `CostControlService.getCosts()`; при `exceeded` отправляется алерт `cost_limit_exceeded` в WebSocket. В дашборде (блок Alerts) отображается сообщение для админа.

### 2.7 Резервное копирование БД
- **Сейчас**: не автоматизировано (зависит от Render/хостинга).
- **Рекомендация**: настроить периодический бэкап PostgreSQL (daily/weekly) в хранилище (S3 и т.п.) через скрипт или сервис хостинга.

### 2.8 Health check и мониторинг
- **Сейчас**: `GET /health` отдаёт состояние БД, WebSocket и т.д.; десктоп опрашивает по таймеру.
- **Улучшение**: использовать этот эндпоинт для Render health check (если ещё не настроено); при падении БД или критичного сервиса логировать и при возможности слать алерт (в лог или во внешнюю систему).

### 2.9 Автоматические тесты
- **Сейчас**: есть юнит-тесты в web, e2e заготовка в backend.
- **Улучшение**: добавить e2e на ключевые сценарии (логин, создание заказа, назначение, завершение) и запускать их в CI при каждом пуше.

### 2.10 Локализация и контент
- **Сейчас**: переводы вручную в en/ru/es/ka.
- **Идея**: скрипт, который по ключам из `en.json` проверяет наличие тех же ключей в остальных локалях и помечает недостающие (чтобы не забыть перевести новые строки).

---

## 3. Краткая сводка

| Категория | Сейчас | Рекомендация |
|-----------|--------|--------------|
| Деплой | Render по Blueprint, миграции в start | Оставить; при необходимости добавить staging через отдельный сервис. |
| События заказов | WebSocket + алерты | Оставить; при необходимости добавить email/push. |
| Аудит | Запись в БД, чтение через API | Оставить; при необходимости экспорт по расписанию. |
| История поездок | Очистка при завершении + cron раз в день (4:00) | ✅ Реализовано. |
| Сессии | lastActiveAt при каждом запросе; cron очистки 90 дней | ✅ Реализовано. |
| Планировщик | Cron: сессии, DriverTripSummary, напоминания, cost limit | ✅ SchedulerModule. |
| CI/CD | GitHub Actions: web build+test, backend build | ✅ .github/workflows/ci.yml. |
| Аналитика | Заглушка | Реализовать heatmap и отчёты по данным заказов. |
| Cost Control | Лимиты + exceeded + алерт в WebSocket каждый час | ✅ Реализовано. |
| Бэкапы | Не описаны | Настроить регулярный бэкап БД на стороне хостинга. |

Документ можно обновлять по мере внедрения пунктов или появления новых идей.
